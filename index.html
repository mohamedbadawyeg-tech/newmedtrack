<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #764ba2;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .patient-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .medication-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            background: #e3f2fd;
            border-right: 5px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-icon {
            width: 50px;
            height: 50px;
            background: #2196f3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-time {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background-color: #4caf50;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-success {
            background: #4caf50;
        }
        
        .btn-success:hover {
            background: #388e3c;
        }
        
        .btn-warning {
            background: #ff9800;
        }
        
        .btn-warning:hover {
            background: #f57c00;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        #fcm-token-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
            border: 2px dashed #ddd;
        }
        
        #notifications-container {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 10px;
            background: #fafafa;
            border-radius: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .notification-help {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #2196f3;
        }
        
        .notification-help h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .notification-help ol {
            margin-right: 20px;
            margin-bottom: 15px;
        }
        
        .notification-help li {
            margin-bottom: 10px;
            padding-right: 10px;
        }
        
        .medication-summary {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #4caf50;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #c8e6c9;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .medication-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-right: 4px solid #2196f3;
        }
        
        .medication-taken {
            border-right-color: #4caf50;
            background: #f1f8e9;
        }
        
        .medication-missed {
            border-right-color: #f44336;
            background: #ffebee;
        }
        
        .critical-medication {
            border-right-color: #ff9800;
            background: #fff3e0;
            animation: pulse 2s infinite;
        }
        
        .patient-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        .patient-avatar {
            width: 60px;
            height: 60px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .patient-details {
            flex: 1;
        }
        
        .progress-bar-small {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .progress-fill-small {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #2e7d32);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .alert-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-success {
            background: #4caf50;
            color: white;
            border-right: 5px solid #2e7d32;
        }
        
        .alert-error {
            background: #f44336;
            color: white;
            border-right: 5px solid #c62828;
        }
        
        .alert-warning {
            background: #ff9800;
            color: white;
            border-right: 5px solid #ef6c00;
        }
        
        .alert-info {
            background: #2196f3;
            color: white;
            border-right: 5px solid #1565c0;
        }
        
        .time-slot-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-right: 4px solid #2196f3;
        }
        
        .time-slot-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #ccc;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-status.online {
            border-right: 4px solid #4caf50;
        }
        
        .connection-status.offline {
            border-right: 4px solid #f44336;
        }
        
        .permission-btn {
            position: fixed;
            bottom: 100px;
            left: 20px;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }
        
        .https-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 9999;
            font-weight: bold;
        }
        
        .settings-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .settings-group {
            margin-bottom: 15px;
        }
        
        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .settings-group input, .settings-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .last-updated {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- ØªØ­Ø°ÙŠØ± HTTPS -->
    <div id="https-warning" class="https-warning" style="display: none;">
        âš ï¸ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª. 
        <a href="#" id="switch-to-https" style="color: white; text-decoration: underline; margin-right: 10px;">
            Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø¢Ù…Ù†
        </a>
        <button onclick="document.getElementById('https-warning').style.display='none'" style="background: white; color: #ff9800; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
            Ø¥ØºÙ„Ø§Ù‚
        </button>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-user-nurse"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©</h1>
            <p>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø£Ø®ÙˆØ°Ø©</p>
        </header>
        
        <div class="patient-info">
            <h2><i class="fas fa-user-injured"></i> Ø§Ù„Ù…Ø±ÙŠØ¶: <span id="patient-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></h2>
            <div class="patient-status">
                <div class="patient-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="patient-details">
                    <div id="patient-status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
                    <div class="progress-bar-small">
                        <div class="progress-fill-small" id="patient-progress"></div>
                    </div>
                    <div id="progress-text" style="font-size: 0.9rem; color: #666;">0%</div>
                </div>
            </div>
        </div>
        
        <div class="status-indicator">
            <div class="status-dot" id="connection-status"></div>
            <span id="connection-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
        </div>
        
        <div id="medication-alert" class="medication-alert">
            <h3><i class="fas fa-bell"></i> ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯!</h3>
            <p id="alert-message"></p>
            <div id="alert-time" style="color: #666; font-size: 0.9rem; margin-top: 5px;"></div>
        </div>
        
        <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
        <div class="medication-summary" id="medication-summary">
            <h3><i class="fas fa-chart-bar"></i> Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h3>
            <div class="summary-item">
                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:</span>
                <span id="total-medications">0</span>
            </div>
            <div class="summary-item">
                <span>ØªÙ… Ø£Ø®Ø°Ù‡Ø§:</span>
                <span id="taken-medications" style="color: #4caf50; font-weight: bold;">0</span>
            </div>
            <div class="summary-item">
                <span>Ù…ØªØ¨Ù‚ÙŠØ©:</span>
                <span id="remaining-medications" style="color: #f44336; font-weight: bold;">0</span>
            </div>
            <div class="summary-item">
                <span>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©:</span>
                <span id="percentage-medications">0%</span>
            </div>
        </div>
        
        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div class="settings-panel">
            <h3><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            
            <div class="settings-group">
                <label for="patient-id-input">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                <input type="text" id="patient-id-input" value="patient_001" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶">
                <small>ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù†ÙØ³ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</small>
            </div>
            
            <div class="settings-group">
                <label for="notification-sound">ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</label>
                <select id="notification-sound">
                    <option value="default">Ø§ÙØªØ±Ø§Ø¶ÙŠ</option>
                    <option value="gentle">Ù†ØºÙ…Ø© Ù„Ø·ÙŠÙØ©</option>
                    <option value="alert">Ù†ØºÙ…Ø© ØªÙ†Ø¨ÙŠÙ‡</option>
                    <option value="none">Ø¨Ø¯ÙˆÙ† ØµÙˆØª</option>
                </select>
            </div>
            
            <div class="settings-group">
                <label for="auto-refresh">Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
                <select id="auto-refresh">
                    <option value="30">ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©</option>
                    <option value="60" selected>ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©</option>
                    <option value="300">ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
                    <option value="0">ØºÙŠØ± Ù…ÙØ¹Ù„</option>
                </select>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-success" id="save-settings">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </button>
                <button class="btn" id="refresh-now">
                    <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†
                </button>
            </div>
        </div>
        
        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div class="notification-help" id="notification-help-section">
            <h3><i class="fas fa-question-circle"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <div id="fcm-token-box">
                <p><strong>Ø±Ù…Ø² FCM Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</strong></p>
                <div id="fcm-token-display">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²" Ø£Ø¯Ù†Ø§Ù‡</div>
                <p class="instructions" style="color: #d32f2f; font-weight: bold;">
                    âš ï¸ Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ùƒ
                </p>
                <div class="button-group">
                    <button class="btn" id="get-token-btn">
                        <i class="fas fa-key"></i> Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²
                    </button>
                    <button class="btn" id="copy-token-btn" style="display: none;">
                        <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²
                    </button>
                    <button class="btn btn-warning" id="test-notification-btn">
                        <i class="fas fa-bell"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                    </button>
                </div>
            </div>
            
            <div id="permission-help" style="margin-top: 20px; display: none;">
                <h4><i class="fas fa-exclamation-triangle"></i> Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¥Ø°Ù†</h4>
                <ol>
                    <li>âœ… ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… <strong>https://</strong> ÙˆÙ„ÙŠØ³ http://</li>
                    <li>âœ… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø±</li>
                    <li>âœ… Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ·Ù„Ø¨ Ø§Ù„Ù…ØªØµÙØ­</li>
                    <li>âœ… Ø¥Ø°Ø§ Ø±ÙØ¶Øª Ø³Ø§Ø¨Ù‚Ø§Ù‹ØŒ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­</li>
                </ol>
                <button class="btn" id="show-browser-settings">
                    <i class="fas fa-cog"></i> ÙØªØ­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
                </button>
            </div>
        </div>
        
        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div class="notification-history">
            <h3><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <div class="button-group" style="margin-bottom: 15px;">
                <button class="btn" id="filter-all">Ø§Ù„ÙƒÙ„</button>
                <button class="btn" id="filter-today">Ø§Ù„ÙŠÙˆÙ…</button>
                <button class="btn" id="filter-critical">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø±Ø¬Ø©</button>
                <button class="btn btn-danger" id="clear-notifications-btn">
                    <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
                </button>
            </div>
            
            <div id="notifications-container">
                <div class="empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                    <p>Ø³ÙŠØ¸Ù‡Ø± Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„Ù‡Ø§</p>
                </div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª -->
        <div id="medications-by-time">
            <h3><i class="fas fa-clock"></i> Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</h3>
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
        </div>
        
        <div class="last-updated">
            Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="last-updated-time">--:--</span>
        </div>
    </div>

    <!-- Ø²Ø± Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <button id="manual-permission-btn" class="permission-btn" style="display: none;">
        <i class="fas fa-bell"></i> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    </button>

    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div class="connection-status offline" id="connection-status-bar">
        <div class="status-dot offline"></div>
        <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <script>
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† HTTPS Ø£ÙˆÙ„Ø§Ù‹
        document.addEventListener('DOMContentLoaded', function() {
            checkHTTPS();
            initializeApp();
        });

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† HTTPS
        function checkHTTPS() {
            const isLocalhost = window.location.hostname === 'localhost' || 
                              window.location.hostname === '127.0.0.1';
            
            const isHttps = window.location.protocol === 'https:';
            
            if (!isLocalhost && !isHttps) {
                document.getElementById('https-warning').style.display = 'block';
                
                document.getElementById('switch-to-https').addEventListener('click', function(e) {
                    e.preventDefault();
                    const currentUrl = window.location.href;
                    const httpsUrl = currentUrl.replace('http://', 'https://');
                    window.location.href = httpsUrl;
                });
            }
        }

        // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAMJjeucsuWiIrOKJ19AK6VT9zLS7ZB6MY",
            authDomain: "medtrackmamdouh.firebaseapp.com",
            projectId: "medtrackmamdouh",
            storageBucket: "medtrackmamdouh.firebasestorage.app",
            messagingSenderId: "588115249832",
            appId: "1:588115249832:web:1e8a2f5dd57db68047909d"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let messaging;
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const appData = {
            fcmToken: "",
            notifications: [],
            patientId: "patient_001",
            patientName: "Ø§Ù„Ù…Ø±ÙŠØ¶",
            patientData: null,
            isConnected: false,
            lastUpdated: null,
            settings: {
                notificationSound: "default",
                autoRefresh: 60,
                showCriticalOnly: false
            }
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        async function initializeApp() {
            try {
                await initializeFirebase();
                loadSettings();
                setupNotificationListeners();
                loadNotifications();
                setupButtons();
                checkConnection();
                updatePatientData();
                startAutoRefresh();
                
                console.log('âœ… Ù„ÙˆØ­Ø© Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø¬Ø§Ù‡Ø²Ø©');
                showAlert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
                showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…', 'error');
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        async function initializeFirebase() {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… FCM
                if (!firebase.messaging.isSupported()) {
                    console.warn("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
                    document.getElementById('permission-help').style.display = 'block';
                    return;
                }
                
                messaging = firebase.messaging();
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const currentPermission = Notification.permission;
                console.log('Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', currentPermission);
                
                if (currentPermission === 'granted') {
                    // Ø§Ù„Ø¥Ø°Ù† Ù…Ù…Ù†ÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„
                    await getAndSaveFCMToken();
                    showAlert('Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„', 'success');
                    
                } else if (currentPermission === 'denied') {
                    // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ø³Ø§Ø¨Ù‚Ø§Ù‹
                    console.warn('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù† Ø³Ø§Ø¨Ù‚Ø§Ù‹');
                    showPermissionHelp();
                    
                } else if (currentPermission === 'default') {
                    // Ù„Ù… ÙŠØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø¹Ø¯
                    console.log('Ù„Ù… ÙŠØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù† Ø¨Ø¹Ø¯');
                    showPermissionRequestButton();
                }
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                setupMessageHandlers();
                
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", error);
                if (error.code === 'messaging/permission-blocked') {
                    showPermissionHelp();
                }
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function setupMessageHandlers() {
            // Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            messaging.onMessage((payload) => {
                console.log('ğŸ“± Ø¥Ø´Ø¹Ø§Ø± ÙˆØ±Ø¯ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', payload);
                handleIncomingNotification(payload);
            });
            
            // Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
            setupPatientListener();
            
            // Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            setupNotificationsListener();
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        function setupPatientListener() {
            db.collection("patients").doc(appData.patientId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        appData.patientData = doc.data();
                        updatePatientDisplay();
                        updateMedicationSummary();
                        updateMedicationsByTime();
                        updateLastUpdated();
                    }
                }, (error) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙ…Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:', error);
                });
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function setupNotificationsListener() {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ Ø±Ù…Ø² FCMØŒ Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù†Ø§
            if (appData.fcmToken) {
                db.collection('notifications')
                    .where('to', '==', appData.fcmToken)
                    .orderBy('sentAt', 'desc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                const notification = change.doc.data();
                                handleIncomingNotification({
                                    notification: notification.notification,
                                    data: notification.data
                                });
                            }
                        });
                    }, (error) => {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
                    });
            }
        }

        // Ø¹Ø±Ø¶ Ø²Ø± Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
        function showPermissionRequestButton() {
            const permissionBtn = document.getElementById('manual-permission-btn');
            permissionBtn.style.display = 'block';
            
            permissionBtn.addEventListener('click', async () => {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        await getAndSaveFCMToken();
                        permissionBtn.style.display = 'none';
                        document.getElementById('permission-help').style.display = 'none';
                        showAlert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    } else {
                        showAlert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'warning');
                        showPermissionHelp();
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†:', error);
                    showAlert('ØªØ¹Ø°Ø± Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'error');
                }
            });
        }

        // Ø¹Ø±Ø¶ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¥Ø°Ù†
        function showPermissionHelp() {
            document.getElementById('permission-help').style.display = 'block';
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² FCM ÙˆØ­ÙØ¸Ù‡
        async function getAndSaveFCMToken() {
            try {
                const token = await messaging.getToken({
                    vapidKey: 'BL49xX41yCVy1aVd3Z34q5UqhVXk2-FsV23V4vE_5Ddx1GZvRUkG-P3N24DZ8n9PqQ4T4tWqJk3Z7hL9pQ6sLkA'
                });
                
                if (token) {
                    appData.fcmToken = token;
                    console.log("âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² FCM:", token.substring(0, 50) + '...');
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù…Ø²
                    document.getElementById('fcm-token-display').textContent = token;
                    document.getElementById('copy-token-btn').style.display = 'inline-block';
                    
                    // Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² ÙÙŠ Firestore
                    await saveCaregiverToken(token);
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                    setupNotificationsListener();
                    
                    return token;
                }
            } catch (tokenError) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² FCM:", tokenError);
                if (tokenError.code === 'messaging/permission-blocked') {
                    showPermissionHelp();
                }
                throw tokenError;
            }
        }

        // Ø­ÙØ¸ Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©
        async function saveCaregiverToken(token) {
            try {
                await db.collection('caregivers').doc('caregiver_001').set({
                    token: token,
                    patientId: appData.patientId,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø²:', error);
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø¯
        function handleIncomingNotification(payload) {
            const title = payload.notification?.title || 'Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯';
            const body = payload.notification?.body || 'ØªÙ… Ø£Ø®Ø° Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯';
            const medication = payload.data?.medication || 'Ø¯ÙˆØ§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const time = payload.data?.time || new Date().toLocaleTimeString();
            const patientName = payload.data?.patientName || appData.patientName;
            const isCritical = payload.data?.type === 'critical' || 
                              medication.includes('Eliquis') || 
                              medication.includes('Plavix');
            
            // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
            showMedicationAlert(medication, time, body, patientName, isCritical);
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            addNotificationToHistory(title, body, medication, time, patientName, isCritical);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
            showSystemNotification(title, body);
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            playNotificationSound();
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
            updatePatientData();
        }

        // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        function showMedicationAlert(medication, time, message, patientName, isCritical = false) {
            const alertDiv = document.getElementById('medication-alert');
            const messageElement = document.getElementById('alert-message');
            const timeElement = document.getElementById('alert-time');
            
            messageElement.innerHTML = `
                <strong>${patientName}</strong> - ${medication}<br>
                ${message}
            `;
            
            timeElement.textContent = `Ø§Ù„ÙˆÙ‚Øª: ${time}`;
            
            if (isCritical) {
                alertDiv.style.background = '#ffebee';
                alertDiv.style.borderColor = '#f44336';
            }
            
            alertDiv.style.display = 'block';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 10000);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
        function addNotificationToHistory(title, body, medication, time, patientName, isCritical = false) {
            const notification = {
                id: Date.now(),
                title: title,
                body: body,
                medication: medication,
                patientName: patientName,
                time: time,
                timestamp: new Date().toISOString(),
                isCritical: isCritical,
                date: new Date().toLocaleDateString('ar-EG')
            };
            
            appData.notifications.unshift(notification);
            
            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
            localStorage.setItem('caregiverNotifications', JSON.stringify(appData.notifications));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            updateNotificationsDisplay();
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function updateNotificationsDisplay(filter = 'all') {
            const container = document.getElementById('notifications-container');
            
            let filteredNotifications = appData.notifications;
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
            if (filter === 'today') {
                const today = new Date().toLocaleDateString('ar-EG');
                filteredNotifications = appData.notifications.filter(n => n.date === today);
            } else if (filter === 'critical') {
                filteredNotifications = appData.notifications.filter(n => n.isCritical);
            }
            
            if (filteredNotifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
                        <p>${filter === 'all' ? 'Ø³ÙŠØ¸Ù‡Ø± Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„Ù‡Ø§' : 
                          filter === 'today' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…' : 
                          'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ø­Ø±Ø¬Ø©'}</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredNotifications.forEach(notification => {
                const criticalClass = notification.isCritical ? 'critical-medication' : '';
                
                html += `
                    <div class="notification ${criticalClass}">
                        <div class="notification-icon">
                            <i class="fas ${notification.isCritical ? 'fa-exclamation-triangle' : 'fa-pills'}"></i>
                        </div>
                        <div class="notification-content">
                            <strong>${notification.title}</strong>
                            <p>${notification.body}</p>
                            <div class="notification-time">
                                <i class="far fa-clock"></i> ${notification.time} - ${notification.date}
                                ${notification.patientName ? ` - ${notification.patientName}` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        function loadNotifications() {
            const saved = localStorage.getItem('caregiverNotifications');
            if (saved) {
                try {
                    appData.notifications = JSON.parse(saved);
                    updateNotificationsDisplay();
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
                }
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        async function updatePatientData() {
            try {
                const doc = await db.collection("patients").doc(appData.patientId).get();
                
                if (doc.exists) {
                    appData.patientData = doc.data();
                    updatePatientDisplay();
                    updateMedicationSummary();
                    updateMedicationsByTime();
                    updateLastUpdated();
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        function updatePatientDisplay() {
            if (!appData.patientData) return;
            
            const patientName = appData.patientData.patientName || 'Ø§Ù„Ù…Ø±ÙŠØ¶';
            const medications = appData.patientData.medications || {};
            const takenCount = Object.keys(medications).length;
            const totalCount = 20; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
            const percentage = Math.round((takenCount / totalCount) * 100);
            
            document.getElementById('patient-name').textContent = patientName;
            document.getElementById('patient-status-text').textContent = 
                `ØªÙ… Ø£Ø®Ø° ${takenCount} Ù…Ù† ${totalCount} Ø¯ÙˆØ§Ø¡`;
            
            document.getElementById('patient-progress').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${percentage}%`;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            updateConnectionStatus(true);
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
        function updateMedicationSummary() {
            if (!appData.patientData) return;
            
            const medications = appData.patientData.medications || {};
            const takenCount = Object.keys(medications).length;
            const totalCount = 20; // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
            const remainingCount = totalCount - takenCount;
            const percentage = Math.round((takenCount / totalCount) * 100);
            
            document.getElementById('total-medications').textContent = totalCount;
            document.getElementById('taken-medications').textContent = takenCount;
            document.getElementById('remaining-medications').textContent = remainingCount;
            document.getElementById('percentage-medications').textContent = `${percentage}%`;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
        function updateMedicationsByTime() {
            if (!appData.patientData) return;
            
            const medications = appData.patientData.medications || {};
            const container = document.getElementById('medications-by-time');
            
            // ØªØ¹Ø±ÙŠÙ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
            const timeSlots = [
                { time: "morning-fasting", name: "Ø§Ù„ØµØ¨Ø§Ø­ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙŠÙ‚", hour: 7 },
                { time: "after-breakfast", name: "Ø¨Ø¹Ø¯ Ø§Ù„ÙØ·Ø§Ø±", hour: 9 },
                { time: "before-lunch", name: "Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡", hour: 13 },
                { time: "after-lunch", name: "Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡", hour: 15 },
                { time: "afternoon", name: "Ø§Ù„Ø¹ØµØ±", hour: 17 },
                { time: "6pm", name: "Ø§Ù„Ø³Ø§Ø¹Ø© 6 Ù…Ø³Ø§Ø¡Ù‹", hour: 18 },
                { time: "after-dinner", name: "Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡", hour: 20 },
                { time: "before-bed", name: "Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…", hour: 22 }
            ];
            
            // Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ù„ÙƒÙ„ ÙˆÙ‚Øª
            const medicationsByTime = {
                'morning-fasting': ['Examide', 'Norvasc', 'Contorloc', 'Corvid'],
                'after-breakfast': ['Aldomet', 'Eliquis', 'Acetyl Cysteine'],
                'before-lunch': ['Forxiga'],
                'after-lunch': ['Suprax', 'Suprax Suspension'],
                'afternoon': ['Eraloner', 'Aldomet'],
                '6pm': ['Cardura'],
                'after-dinner': ['Plavix', 'Lipitor', 'Moxiflox', 'Spiriva'],
                'before-bed': ['Eliquis', 'Aldomet', 'Acetyl Cysteine']
            };
            
            let html = '';
            
            timeSlots.forEach(slot => {
                const slotMeds = medicationsByTime[slot.time] || [];
                const takenMeds = slotMeds.filter(med => {
                    const medKey = `${med}-${slot.time}`;
                    return medications[medKey];
                });
                
                const isUpcoming = new Date().getHours() < slot.hour;
                const isCurrent = new Date().getHours() === slot.hour;
                
                let statusClass = '';
                if (takenMeds.length === slotMeds.length && slotMeds.length > 0) {
                    statusClass = 'completed';
                } else if (isCurrent) {
                    statusClass = 'current';
                } else if (isUpcoming) {
                    statusClass = 'upcoming';
                }
                
                html += `
                    <div class="time-slot-section ${statusClass}">
                        <div class="time-slot-title">
                            <div>
                                <strong>${slot.name}</strong>
                                <small style="color: #666;">(${slot.hour}:00)</small>
                            </div>
                            <div>
                                ${takenMeds.length}/${slotMeds.length}
                            </div>
                        </div>
                `;
                
                if (slotMeds.length > 0) {
                    slotMeds.forEach(med => {
                        const medKey = `${med}-${slot.time}`;
                        const isTaken = medications[medKey];
                        const isCritical = med.includes('Eliquis') || med.includes('Plavix');
                        const medClass = isTaken ? 'medication-taken' : 'medication-missed';
                        const criticalClass = isCritical ? 'critical-medication' : '';
                        
                        html += `
                            <div class="medication-item ${medClass} ${criticalClass}">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${med}</strong>
                                        ${isCritical ? ' <span style="color: #f44336;">âš ï¸</span>' : ''}
                                    </div>
                                    <div>
                                        ${isTaken ? 
                                            '<span style="color: #4caf50;"><i class="fas fa-check-circle"></i> ØªÙ… Ø£Ø®Ø°Ù‡</span>' : 
                                            '<span style="color: #f44336;"><i class="fas fa-times-circle"></i> Ù„Ù… ÙŠØ¤Ø®Ø°</span>'}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += `<p style="color: #666; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª</p>`;
                }
                
                html += `</div>`;
            });
            
            container.innerHTML = `<h3><i class="fas fa-clock"></i> Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</h3>${html}`;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
        function showSystemNotification(title, body) {
            if (!("Notification" in window)) return;
            
            if (Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/206/206875.png',
                    requireInteraction: true,
                    tag: 'medication-notification'
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
            }
        }

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
        function playNotificationSound() {
            try {
                let soundUrl;
                switch(appData.settings.notificationSound) {
                    case 'gentle':
                        soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3';
                        break;
                    case 'alert':
                        soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3';
                        break;
                    default:
                        soundUrl = 'https://assets.mixkit.co/sfx/preview/mixkit-notification-urn-2536.mp3';
                }
                
                if (appData.settings.notificationSound !== 'none') {
                    const audio = new Audio(soundUrl);
                    audio.volume = 0.3;
                    audio.play();
                }
            } catch (error) {
                console.log('âŒ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª');
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        function checkConnection() {
            const statusDot = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            const statusBar = document.getElementById('connection-status-bar');
            
            if (navigator.onLine && appData.patientData) {
                statusDot.className = 'status-dot online';
                statusText.textContent = 'Ù…ØªØµÙ„ - Ø¬Ø§Ù‡Ø² Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
                statusBar.className = 'connection-status online';
                statusBar.querySelector('.status-dot').className = 'status-dot online';
                statusBar.querySelector('span').textContent = 'Ù…ØªØµÙ„';
                appData.isConnected = true;
            } else {
                statusDot.className = 'status-dot';
                statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                statusBar.className = 'connection-status offline';
                statusBar.querySelector('.status-dot').className = 'status-dot offline';
                statusBar.querySelector('span').textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                appData.isConnected = false;
            }
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('last-updated-time').textContent = timeString;
            appData.lastUpdated = now;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        function loadSettings() {
            const saved = localStorage.getItem('caregiverSettings');
            if (saved) {
                try {
                    appData.settings = JSON.parse(saved);
                    document.getElementById('notification-sound').value = appData.settings.notificationSound;
                    document.getElementById('auto-refresh').value = appData.settings.autoRefresh;
                    document.getElementById('patient-id-input').value = appData.patientId;
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
                }
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        function saveSettings() {
            appData.settings.notificationSound = document.getElementById('notification-sound').value;
            appData.settings.autoRefresh = document.getElementById('auto-refresh').value;
            appData.patientId = document.getElementById('patient-id-input').value.trim() || 'patient_001';
            
            localStorage.setItem('caregiverSettings', JSON.stringify(appData.settings));
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶
            setupPatientListener();
            
            showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function startAutoRefresh() {
            const refreshInterval = parseInt(appData.settings.autoRefresh) * 1000;
            
            if (refreshInterval > 0) {
                setInterval(() => {
                    if (appData.isConnected) {
                        updatePatientData();
                    }
                }, refreshInterval);
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        function setupButtons() {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²
            document.getElementById('get-token-btn').addEventListener('click', async function() {
                try {
                    await getAndSaveFCMToken();
                    showAlert('ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } catch (error) {
                    showAlert('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²', 'error');
                }
            });
            
            // Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²
            document.getElementById('copy-token-btn').addEventListener('click', function() {
                navigator.clipboard.writeText(appData.fcmToken)
                    .then(() => {
                        showAlert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
                    })
                    .catch(() => {
                        const textArea = document.createElement('textarea');
                        textArea.value = appData.fcmToken;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showAlert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²', 'success');
                    });
            });
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            document.getElementById('test-notification-btn').addEventListener('click', function() {
                showMedicationAlert(
                    'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙˆØ§Ø¡',
                    new Date().toLocaleTimeString(),
                    'Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…',
                    'Ø§Ù„Ù†Ø¸Ø§Ù…',
                    false
                );
                
                addNotificationToHistory(
                    'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…',
                    'ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­',
                    'Ø¯ÙˆØ§Ø¡ ØªØ¬Ø±ÙŠØ¨ÙŠ',
                    new Date().toLocaleTimeString(),
                    'Ø§Ù„Ù†Ø¸Ø§Ù…',
                    false
                );
                
                showSystemNotification('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…', 'ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                showAlert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø±', 'info');
            });
            
            // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
            document.getElementById('clear-notifications-btn').addEventListener('click', function() {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ')) {
                    appData.notifications = [];
                    localStorage.removeItem('caregiverNotifications');
                    updateNotificationsDisplay();
                    showAlert('ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'success');
                }
            });
            
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            document.getElementById('filter-all').addEventListener('click', () => updateNotificationsDisplay('all'));
            document.getElementById('filter-today').addEventListener('click', () => updateNotificationsDisplay('today'));
            document.getElementById('filter-critical').addEventListener('click', () => updateNotificationsDisplay('critical'));
            
            // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            document.getElementById('save-settings').addEventListener('click', saveSettings);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†
            document.getElementById('refresh-now').addEventListener('click', () => {
                updatePatientData();
                showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
            });
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
            document.getElementById('show-browser-settings').addEventListener('click', showBrowserSettings);
        }

        // Ø¹Ø±Ø¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­
        function showBrowserSettings() {
            const helpText = `
            ÙƒÙŠÙÙŠØ© Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:
            
            Chrome:
            1. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ ğŸ”’ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·
            2. Ø§Ø®ØªØ± "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹"
            3. ØºÙŠÙ‘Ø± "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" Ø¥Ù„Ù‰ "Ø§Ù„Ø³Ù…Ø§Ø­"
            
            Firefox:
            1. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ ğŸ”’ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·
            2. Ø§Ø®ØªØ± "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„"
            3. ØºÙŠÙ‘Ø± "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" Ø¥Ù„Ù‰ "Ø§Ù„Ø³Ù…Ø§Ø­"
            
            Safari:
            1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ÙˆÙŠØ¨ â†’ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            2. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø®ØªØ± "Ø§Ù„Ø³Ù…Ø§Ø­"
            
            Edge:
            1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â†’ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª â†’ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            2. Ø£Ø¶Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
            `;
            
            alert(helpText);
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-message alert-${type}`;
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                  type === 'error' ? 'fa-times-circle' : 
                                  type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translateY(-20px)';
                setTimeout(() => document.body.removeChild(alertDiv), 300);
            }, 3000);
        }

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', () => {
            checkConnection();
            showAlert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
        });
        
        window.addEventListener('offline', () => {
            checkConnection();
            showAlert('ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'warning');
        });

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        setInterval(checkConnection, 30000);
    </script>
</body>
</html>
