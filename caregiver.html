<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© - Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #764ba2;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        h2 {
            color: #764ba2;
            margin: 20px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        h3 {
            color: #444;
            margin: 15px 0 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .patient-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .patient-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .medication-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification {
            background: white;
            border-right: 5px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #eee;
        }
        
        .notification:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .notification.critical {
            border-right-color: #f44336;
            background: #ffebee;
        }
        
        .notification.warning {
            border-right-color: #ff9800;
            background: #fff3e0;
        }
        
        .notification.success {
            border-right-color: #4caf50;
            background: #e8f5e9;
        }
        
        .notification-icon {
            width: 50px;
            height: 50px;
            background: #2196f3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .notification.critical .notification-icon {
            background: #f44336;
        }
        
        .notification.warning .notification-icon {
            background: #ff9800;
        }
        
        .notification.success .notification-icon {
            background: #4caf50;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-time {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background-color: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.offline {
            background-color: #f44336;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-success { background: #4caf50; }
        .btn-success:hover { background: #388e3c; }
        
        .btn-warning { background: #ff9800; }
        .btn-warning:hover { background: #f57c00; }
        
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #d32f2f; }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        #fcm-token-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
            border: 2px dashed #ddd;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        #notifications-container {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 10px;
            background: #fafafa;
            border-radius: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .medication-today {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .medication-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .medication-item:last-child {
            border-bottom: none;
        }
        
        .med-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-taken {
            background: #c8e6c9;
            color: #2e7d32;
        }
        
        .status-missed {
            background: #ffcdd2;
            color: #c62828;
        }
        
        .status-pending {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .firebase-info {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .patient-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .patient-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 200px;
        }
        
        .patient-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .patient-card.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .chart-placeholder {
            height: 200px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .emergency-contact {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .info-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .floating-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .badge-success { background: #c8e6c9; color: #2e7d32; }
        .badge-warning { background: #fff3e0; color: #ef6c00; }
        .badge-danger { background: #ffcdd2; color: #c62828; }
        .badge-info { background: #bbdefb; color: #1565c0; }
        
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        
        .message-box textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            resize: vertical;
        }
        
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ø§Ø¦Ù…Ø© -->
    <div class="floating-alert" id="floating-alert"></div>
    
    <!-- Ù…Ø±Ø¨Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© -->
    <div class="message-box" id="message-box">
        <h4><i class="fas fa-comment-medical"></i> Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø±ÙŠØ¶</h4>
        <textarea id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." rows="3"></textarea>
        <div class="action-buttons">
            <button class="btn btn-success btn-small" id="send-message-btn">
                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
            </button>
            <button class="btn btn-danger btn-small" id="cancel-message-btn">
                <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
            </button>
        </div>
    </div>
    
    <!-- Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª -->
    <div class="sound-toggle" id="sound-toggle">
        <i class="fas fa-volume-up" id="sound-icon"></i>
    </div>
    
    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="container">
        <header>
            <h1><i class="fas fa-user-nurse"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©</h1>
            <p>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø£Ø®ÙˆØ°Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</p>
        </header>
        
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ -->
        <div class="patient-info">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2><i class="fas fa-user-injured"></i> Ø§Ù„Ù…Ø±ÙŠØ¶: <span id="patient-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></h2>
                    <p id="patient-status">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
                </div>
                <div id="patient-selection" style="display: none;">
                    <select id="patient-select" class="btn" style="background: white; color: #333;">
                        <option value="">Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶Ø§Ù‹...</option>
                    </select>
                </div>
            </div>
            
            <div class="patient-stats">
                <div class="stat-card">
                    <div><i class="fas fa-pills"></i> Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…</div>
                    <div class="stat-value" id="total-medications">0</div>
                    <div>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-check-circle"></i> ØªÙ… Ø£Ø®Ø°Ù‡Ø§</div>
                    <div class="stat-value" id="taken-medications">0</div>
                    <div>Ø£Ø¯ÙˆÙŠØ© ØªÙ… ØªÙ†Ø§ÙˆÙ„Ù‡Ø§</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-times-circle"></i> Ù„Ù… ØªØ¤Ø®Ø°</div>
                    <div class="stat-value" id="missed-medications">0</div>
                    <div>Ø£Ø¯ÙˆÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ©</div>
                </div>
                <div class="stat-card">
                    <div><i class="fas fa-percentage"></i> Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</div>
                    <div class="stat-value" id="compliance-rate">0%</div>
                    <div>Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
            </div>
        </div>
        
        <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
        <div class="status-indicator">
            <div class="status-dot" id="connection-status"></div>
            <span id="connection-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...</span>
            <div style="margin-right: auto;"></div>
            <span id="connection-time" style="color: #666; font-size: 0.9rem;"></span>
        </div>
        
        <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø±Ø¬Ø© -->
        <div id="medication-alert" class="medication-alert">
            <h3><i class="fas fa-bell"></i> ØªÙ†Ø¨ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯!</h3>
            <p id="alert-message"></p>
            <div class="action-buttons" style="margin-top: 10px;">
                <button class="btn btn-success btn-small" id="acknowledge-alert-btn">
                    <i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ø§Ø·Ù„Ø§Ø¹
                </button>
                <button class="btn btn-warning btn-small" id="remind-patient-btn">
                    <i class="fas fa-bell"></i> ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶
                </button>
            </div>
        </div>
        
        <!-- Ø´Ø¨ÙƒØ© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="dashboard-grid">
            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
            <div class="info-box">
                <h3><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                <div class="firebase-info">
                    <p><strong>Ø­Ø§Ù„Ø© Firebase:</strong> <span id="firebase-status-text">ØºÙŠØ± Ù…ØªØµÙ„</span></p>
                    <p><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> <span id="last-update-time">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«</span></p>
                </div>
                
                <div id="fcm-token-box">
                    <p><strong>Ø±Ù…Ø² FCM Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</strong></p>
                    <div id="fcm-token-display">Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ù…Ø²...</div>
                    <p class="instructions" style="color: #666; font-size: 0.9rem; margin: 10px 0;">
                        Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ùƒ
                    </p>
                    <div class="action-buttons">
                        <button class="btn" id="copy-token-btn">
                            <i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²
                        </button>
                        <button class="btn btn-warning" id="refresh-token-btn">
                            <i class="fas fa-redo"></i> ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø²
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Ø±Ø³Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø© -->
            <div class="info-box">
                <h3><i class="fas fa-comment-medical"></i> Ø±Ø³Ø§Ø¦Ù„ Ø³Ø±ÙŠØ¹Ø©</h3>
                <p style="margin-bottom: 15px;">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø³Ø¨Ù‚Ø© Ù„Ù„Ù…Ø±ÙŠØ¶:</p>
                <div class="action-buttons">
                    <button class="btn btn-success btn-small" data-message="Ù‡Ù„ Ø£Ø®Ø°Øª Ø£Ø¯ÙˆÙŠØªÙƒØŸ">
                        <i class="fas fa-question"></i> Ù‡Ù„ Ø£Ø®Ø°Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©ØŸ
                    </button>
                    <button class="btn btn-warning btn-small" data-message="Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ø¡">
                        <i class="fas fa-clock"></i> ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¯ÙˆØ§Ø¡
                    </button>
                    <button class="btn btn-small" data-message="ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ">
                        <i class="fas fa-heart"></i> ÙƒÙŠÙ Ø­Ø§Ù„ÙƒØŸ
                    </button>
                    <button class="btn btn-danger btn-small" id="custom-message-btn">
                        <i class="fas fa-edit"></i> Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ©
                    </button>
                </div>
                
                <div class="emergency-contact" style="margin-top: 20px;">
                    <h4><i class="fas fa-phone-alt"></i> Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h4>
                    <p><strong>Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø£Ø³Ø±Ø©:</strong> 0123456789</p>
                                    <p><strong>Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰:</strong> 0112345678</p>
                    <p><strong>Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:</strong> 123</p>
                </div>
            </div>
        </div>
        
        <!-- Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ… -->
        <div class="medication-today">
            <h3><i class="fas fa-calendar-day"></i> Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„ÙŠÙˆÙ…</h3>
            <div id="today-medications">
                <div class="empty-state">
                    <i class="fas fa-pills"></i>
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…...</p>
                </div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
        <div class="chart-container">
            <h3><i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</h3>
            <div class="chart-placeholder">
                <div style="text-align: center;">
                    <i class="fas fa-chart-line" style="font-size: 3rem; color: #667eea; margin-bottom: 10px;"></i>
                    <p>Ø³ÙŠØ¸Ù‡Ø± Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„ØªØ·ÙˆØ± Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</p>
                </div>
            </div>
        </div>
        
        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div class="notification-history">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                <div class="action-buttons">
                    <button class="btn btn-success btn-small" id="mark-all-read-btn">
                        <i class="fas fa-check-double"></i> ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
                    </button>
                    <button class="btn btn-danger btn-small" id="clear-notifications-btn">
                        <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
                    </button>
                </div>
            </div>
            
            <div id="notifications-container">
                <div class="empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                    <p>Ø³ÙŠØ¸Ù‡Ø± Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„Ù‡Ø§</p>
                </div>
            </div>
        </div>
        
        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
        <div style="text-align: center; margin-top: 30px;">
            <div class="action-buttons" style="justify-content: center;">
                <button class="btn btn-warning" id="test-notification-btn">
                    <i class="fas fa-bell"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                </button>
                <button class="btn" id="sync-data-btn">
                    <i class="fas fa-sync"></i> Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                <button class="btn btn-success" id="export-report-btn">
                    <i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±
                </button>
            </div>
        </div>
        
        <footer style="text-align: center; margin-top: 40px; padding-top: 20px; color: #666; border-top: 1px solid #eee;">
            <p>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© &copy; 2024 | Ù…ØªØµÙ„Ø© Ø¨Ù€ Firebase Cloud</p>
            <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØªÙ… Ù†Ù‚Ù„Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† ÙˆÙ…Ø´ÙÙ‘Ø±</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <script>
        // âš ï¸ ØªÙƒÙˆÙŠÙ† Firebase - Ù†ÙØ³ ØªÙƒÙˆÙŠÙ† Ø§Ù„Ù…Ø±ÙŠØ¶
        const firebaseConfig = {
            apiKey: "AIzaSyAMJjeucsuWiIrOKJ19AK6VT9zLS7ZB6MY",
            authDomain: "medtrackmamdouh.firebaseapp.com",
            projectId: "medtrackmamdouh",
            storageBucket: "medtrackmamdouh.firebasestorage.app",
            messagingSenderId: "588115249832",
            appId: "1:588115249832:web:1e8a2f5dd57db68047909d"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let messaging;
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const appData = {
            fcmToken: "",
            caregiverId: "caregiver_" + Math.random().toString(36).substr(2, 9),
            notifications: [],
            patients: [],
            selectedPatientId: "patient_001",
            selectedPatientName: "Ø§Ù„Ù…Ø±ÙŠØ¶",
            selectedPatientData: null,
            isConnected: false,
            lastUpdate: null,
            soundEnabled: true,
            unreadNotifications: 0
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initializeFirebase();
                setupNotificationListeners();
                loadNotifications();
                setupButtons();
                checkConnection();
                loadPatients();
                setupSoundToggle();
                
                console.log('âœ… Ù„ÙˆØ­Ø© Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø¬Ø§Ù‡Ø²Ø©');
                showFloatingAlert('Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¬Ø§Ù‡Ø²Ø©', 'success');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
                setInterval(checkConnection, 30000);
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
                setInterval(updatePatientData, 60000);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
                showFloatingAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ' + error.message, 'error');
            }
        });

        // ØªÙ‡ÙŠØ¦Ø© Firebase Ùˆ Cloud Messaging
        async function initializeFirebase() {
            try {
                updateConnectionStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...', 'offline');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… FCM
                if (!firebase.messaging.isSupported()) {
                    throw new Error('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                }
                
                messaging = firebase.messaging();
                
                // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    console.warn('âš ï¸ ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
                    showFloatingAlert('ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª', 'warning');
                }
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² FCM
                const token = await messaging.getToken({
                    vapidKey: 'BAHsKe2WSUDaXMcroeNScTprRmE2NTIBDyv9fYmVsuUddhERvybIKM7EBNgSHnuZ91Q9QU9V034IXnVDbeEG9oQ'
                });
                
                if (token) {
                    appData.fcmToken = token;
                    document.getElementById('fcm-token-display').textContent = token;
                    await saveCaregiverToken(token);
                    
                    console.log('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² FCM:', token.substring(0, 50) + '...');
                    updateConnectionStatus('Ù…ØªØµÙ„ Ø¨Ù€ Firebase', 'online');
                    appData.isConnected = true;
                    
                    showFloatingAlert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
                document.getElementById('fcm-token-display').textContent = 'Ø®Ø·Ø£: ' + error.message;
                updateConnectionStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, 'offline');
                appData.isConnected = false;
            }
        }

        // Ø­ÙØ¸ Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© ÙÙŠ Firebase
        async function saveCaregiverToken(token) {
            try {
                await db.collection('caregivers').doc(appData.caregiverId).set({
                    token: token,
                    caregiverId: appData.caregiverId,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    patients: [appData.selectedPatientId]
                }, { merge: true });
                
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù…Ø² Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ©');
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø²:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰
        async function loadPatients() {
            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ù…Ù† Firestore
                const patientsSnapshot = await db.collection('patients').limit(10).get();
                
                if (!patientsSnapshot.empty) {
                    appData.patients = [];
                    patientsSnapshot.forEach(doc => {
                        const patientData = doc.data();
                        appData.patients.push({
                            id: doc.id,
                            name: patientData.patientName || 'Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                            age: patientData.patientAge || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                            lastUpdate: patientData.lastUpdated
                        });
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±ÙŠØ¶
                    if (appData.patients.length > 1) {
                        updatePatientSelector();
                        document.getElementById('patient-selection').style.display = 'block';
                    }
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù…Ø®ØªØ§Ø±
                    await loadSelectedPatientData();
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶
        function updatePatientSelector() {
            const selectElement = document.getElementById('patient-select');
            selectElement.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶Ø§Ù‹...</option>';
            
            appData.patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.name} (${patient.age} Ø³Ù†Ø©)`;
                if (patient.id === appData.selectedPatientId) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶
            selectElement.addEventListener('change', async function() {
                if (this.value) {
                    appData.selectedPatientId = this.value;
                    const selectedPatient = appData.patients.find(p => p.id === this.value);
                    appData.selectedPatientName = selectedPatient ? selectedPatient.name : 'Ø§Ù„Ù…Ø±ÙŠØ¶';
                    await loadSelectedPatientData();
                }
            });
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù…Ø®ØªØ§Ø±
        async function loadSelectedPatientData() {
            try {
                const patientDoc = await db.collection('patients').doc(appData.selectedPatientId).get();
                
                if (patientDoc.exists) {
                    appData.selectedPatientData = patientDoc.data();
                    updatePatientInfo();
                    updateMedicationList();
                    updatePatientStats();
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
                await loadRecentMedicationEvents();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        function updatePatientInfo() {
            if (appData.selectedPatientData) {
                document.getElementById('patient-name').textContent = appData.selectedPatientData.patientName || 'Ø§Ù„Ù…Ø±ÙŠØ¶';
                
                const takenCount = appData.selectedPatientData.medicationsTakenToday || 0;
                const totalCount = appData.selectedPatientData.totalMedications || 0;
                const compliance = totalCount > 0 ? Math.round((takenCount / totalCount) * 100) : 0;
                
                document.getElementById('patient-status').innerHTML = `
                    <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${compliance >= 80 ? 'âœ… Ø¬ÙŠØ¯Ø©' : compliance >= 50 ? 'âš ï¸ Ù…ØªÙˆØ³Ø·Ø©' : 'âŒ ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©'} 
                    | <strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> ${new Date().toLocaleTimeString('ar-EG')}
                `;
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ÙŠÙˆÙ…
        async function updateMedicationList() {
            const container = document.getElementById('today-medications');
            
            try {
                // Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙŠÙˆÙ…
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const eventsSnapshot = await db.collection('medication_events')
                    .where('patientId', '==', appData.selectedPatientId)
                    .where('timestamp', '>=', today)
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                if (eventsSnapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-pills"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆÙŠØ© Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                const eventsByMedication = {};
                
                eventsSnapshot.forEach(doc => {
                    const event = doc.data();
                    if (!eventsByMedication[event.medication]) {
                        eventsByMedication[event.medication] = [];
                    }
                    eventsByMedication[event.medication].push(event);
                });
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ù…Ø¹ Ø­Ø§Ù„ØªÙ‡Ø§
                Object.keys(eventsByMedication).forEach(medicationName => {
                    const events = eventsByMedication[medicationName];
                    const latestEvent = events[0];
                    const status = latestEvent.type === 'medication_taken' ? 'taken' : 'missed';
                    const time = latestEvent.timestamp ? 
                        new Date(latestEvent.timestamp.toDate()).toLocaleTimeString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    html += `
                        <div class="medication-item">
                            <div>
                                <strong>${medicationName}</strong><br>
                                <small>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${time}</small>
                            </div>
                            <div class="med-status status-${status}">
                                ${status === 'taken' ? 'âœ… ØªÙ… Ø£Ø®Ø°Ù‡' : 'âŒ Ù„Ù… ÙŠØ¤Ø®Ø°'}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</p>
                    </div>
                `;
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        function updatePatientStats() {
            if (appData.selectedPatientData) {
                const takenCount = appData.selectedPatientData.medicationsTakenToday || 0;
                const totalCount = appData.selectedPatientData.totalMedications || allMedications.length;
                const missedCount = totalCount - takenCount;
                const compliance = totalCount > 0 ? Math.round((takenCount / totalCount) * 100) : 0;
                
                document.getElementById('total-medications').textContent = totalCount;
                document.getElementById('taken-medications').textContent = takenCount;
                document.getElementById('missed-medications').textContent = missedCount;
                document.getElementById('compliance-rate').textContent = compliance + '%';
                
                // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…
                const complianceElement = document.getElementById('compliance-rate');
                if (compliance >= 80) {
                    complianceElement.style.color = '#4caf50';
                } else if (compliance >= 50) {
                    complianceElement.style.color = '#ff9800';
                } else {
                    complianceElement.style.color = '#f44336';
                }
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
        async function loadRecentMedicationEvents() {
            try {
                const eventsSnapshot = await db.collection('medication_events')
                    .where('patientId', '==', appData.selectedPatientId)
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                eventsSnapshot.forEach(doc => {
                    const event = doc.data();
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    handleNewMedicationEvent(event, doc.id);
                });
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:', error);
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function setupNotificationListeners() {
            // Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            messaging.onMessage((payload) => {
                console.log('ğŸ“± Ø¥Ø´Ø¹Ø§Ø± ÙˆØ±Ø¯ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', payload);
                handleIncomingNotification(payload);
            });
            
            // Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Firestore (Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
            db.collection('medication_events')
                .where('patientId', '==', appData.selectedPatientId)
                .orderBy('timestamp', 'desc')
                .limit(10)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const event = change.doc.data();
                            handleNewMedicationEvent(event, change.doc.id);
                        }
                    });
                });
            
            // Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
            db.collection('patients').doc(appData.selectedPatientId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        appData.selectedPatientData = doc.data();
                        updatePatientInfo();
                        updatePatientStats();
                        updateLastUpdateTime();
                    }
                });
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø¯Ø« Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯
        function handleNewMedicationEvent(event, eventId) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø­Ø¯Ø«
            if (appData.notifications.some(n => n.eventId === eventId)) {
                return;
            }
            
            const title = event.type === 'medication_taken' ? 'âœ… ØªÙ… Ø£Ø®Ø° Ø§Ù„Ø¯ÙˆØ§Ø¡' : 'âš ï¸ Ø¯ÙˆØ§Ø¡ Ù…ÙÙ‚ÙˆØ¯';
            const body = `${event.patientName} ${event.type === 'medication_taken' ? 'Ø£Ø®Ø°' : 'Ù„Ù… ÙŠØ£Ø®Ø°'} ${event.medication}`;
            const time = event.timestamp ? new Date(event.timestamp.toDate()).toLocaleTimeString('ar-EG') : 'Ø§Ù„Ø¢Ù†';
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            addNotificationToHistory(title, body, event.medication, time, eventId, event.type);
            
            // Ø¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹
            if (event.timestamp && (new Date() - event.timestamp.toDate()) < 300000) { // Ø£Ù‚Ù„ Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚
                showMedicationAlert(event.medication, time, body);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
                showSystemNotification(title, body);
                
                // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                if (appData.soundEnabled) {
                    playNotificationSound();
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©
            updateMedicationList();
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆØ§Ø±Ø¯
        function handleIncomingNotification(payload) {
            const title = payload.notification?.title || 'Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯';
            const body = payload.notification?.body || 'ØªÙ… Ø£Ø®Ø° Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯';
            const medication = payload.data?.medication || 'Ø¯ÙˆØ§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const time = payload.data?.time || new Date().toLocaleTimeString('ar-EG');
            const type = payload.data?.type || 'info';
            
            // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
            showMedicationAlert(medication, time, body);
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            addNotificationToHistory(title, body, medication, time, Date.now().toString(), type);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
            showSystemNotification(title, body);
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            if (appData.soundEnabled) {
                playNotificationSound();
            }
        }

        // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        function showMedicationAlert(medication, time, message) {
            const alertDiv = document.getElementById('medication-alert');
            const messageElement = document.getElementById('alert-message');
            
            messageElement.innerHTML = `
                <strong>${medication}</strong><br>
                <small>Ø§Ù„ÙˆÙ‚Øª: ${time}</small><br>
                ${message}
            `;
            
            alertDiv.style.display = 'block';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 10000);
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
        function addNotificationToHistory(title, body, medication, time, eventId, type = 'info') {
            const notification = {
                id: Date.now(),
                eventId: eventId,
                title: title,
                body: body,
                medication: medication,
                time: time,
                type: type,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            appData.notifications.unshift(notification);
            if (!notification.read) {
                appData.unreadNotifications++;
            }
            
            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
            localStorage.setItem('caregiverNotifications', JSON.stringify(appData.notifications));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            updateNotificationsDisplay();
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function updateNotificationsDisplay() {
            const container = document.getElementById('notifications-container');
            
            if (appData.notifications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                        <p>Ø³ÙŠØ¸Ù‡Ø± Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„Ù‡Ø§</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            appData.notifications.forEach(notification => {
                const notificationClass = notification.type === 'critical' ? 'critical' : 
                                        notification.type === 'warning' ? 'warning' : 
                                        notification.type === 'medication_taken' ? 'success' : '';
                
                const icon = notification.type === 'medication_taken' ? 'fa-pills' :
                           notification.type === 'critical' ? 'fa-exclamation-triangle' :
                           notification.type === 'warning' ? 'fa-exclamation-circle' : 'fa-bell';
                
                const readClass = notification.read ? '' : 'unread';
                
                html += `
                    <div class="notification ${notificationClass} ${readClass}" data-id="${notification.id}">
                        <div class="notification-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="notification-content">
                            <strong>${notification.title}</strong>
                            <p>${notification.body}</p>
                            <div class="notification-time">
                                <i class="far fa-clock"></i> ${notification.time}
                                ${!notification.read ? '<span class="badge badge-warning">Ø¬Ø¯ÙŠØ¯</span>' : ''}
                            </div>
                        </div>
                        <div class="notification-actions">
                            ${!notification.read ? `
                            <button class="btn btn-success btn-small mark-read-btn" data-id="${notification.id}">
                                <i class="fas fa-check"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ù‚Ø±ÙˆØ¡
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const notificationId = this.getAttribute('data-id');
                    markNotificationAsRead(notificationId);
                });
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
            document.querySelectorAll('.notification').forEach(notif => {
                notif.addEventListener('click', function() {
                    const notificationId = this.getAttribute('data-id');
                    markNotificationAsRead(notificationId);
                });
            });
        }

        // ØªØ¹Ù„ÙŠÙ… Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡
        function markNotificationAsRead(notificationId) {
            const notification = appData.notifications.find(n => n.id == notificationId);
            if (notification && !notification.read) {
                notification.read = true;
                appData.unreadNotifications--;
                updateNotificationsDisplay();
                localStorage.setItem('caregiverNotifications', JSON.stringify(appData.notifications));
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        function loadNotifications() {
            const saved = localStorage.getItem('caregiverNotifications');
            if (saved) {
                try {
                    appData.notifications = JSON.parse(saved);
                    appData.unreadNotifications = appData.notifications.filter(n => !n.read).length;
                    updateNotificationsDisplay();
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
                }
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
        function showSystemNotification(title, body) {
            if (!("Notification" in window)) return;
            
            if (Notification.permission === "granted") {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/206/206875.png',
                    tag: 'medication-notification'
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
            }
        }

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
        function playNotificationSound() {
            try {
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
                audio.volume = 0.3;
                audio.play();
            } catch (error) {
                console.log('âŒ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª');
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        function checkConnection() {
            const statusDot = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            const connectionTime = document.getElementById('connection-time');
            
            if (navigator.onLine && appData.isConnected) {
                statusDot.className = 'status-dot online';
                statusText.textContent = 'Ù…ØªØµÙ„ - Ø¬Ø§Ù‡Ø² Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
                statusText.style.color = '#4caf50';
                appData.isConnected = true;
            } else if (navigator.onLine) {
                statusDot.className = 'status-dot';
                statusText.textContent = 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ„ÙƒÙ† ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ Firebase';
                statusText.style.color = '#ff9800';
                appData.isConnected = false;
            } else {
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                statusText.style.color = '#f44336';
                appData.isConnected = false;
            }
            
            connectionTime.textContent = new Date().toLocaleTimeString('ar-EG');
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateConnectionStatus(message, status) {
            const statusDot = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            const firebaseStatus = document.getElementById('firebase-status-text');
            
            statusText.textContent = message;
            firebaseStatus.textContent = message;
            
            if (status === 'online') {
                statusDot.className = 'status-dot online';
                statusText.style.color = '#4caf50';
                firebaseStatus.style.color = '#4caf50';
                appData.isConnected = true;
            } else {
                statusDot.className = 'status-dot offline';
                statusText.style.color = '#f44336';
                firebaseStatus.style.color = '#f44336';
                appData.isConnected = false;
            }
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
        function updateLastUpdateTime() {
            appData.lastUpdate = new Date();
            document.getElementById('last-update-time').textContent = 
                appData.lastUpdate.toLocaleTimeString('ar-EG');
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        function setupButtons() {
            // Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²
            document.getElementById('copy-token-btn').addEventListener('click', function() {
                navigator.clipboard.writeText(appData.fcmToken)
                    .then(() => {
                        showFloatingAlert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø² Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
                    })
                    .catch(() => {
                        const textArea = document.createElement('textarea');
                        textArea.value = appData.fcmToken;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showFloatingAlert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø²', 'success');
                    });
            });
            
            // ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø²
            document.getElementById('refresh-token-btn').addEventListener('click', async function() {
                try {
                    const newToken = await messaging.getToken();
                    if (newToken) {
                        appData.fcmToken = newToken;
                        document.getElementById('fcm-token-display').textContent = newToken;
                        await saveCaregiverToken(newToken);
                        showFloatingAlert('ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    }
                } catch (error) {
                    showFloatingAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ù…Ø²', 'error');
                }
            });
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            document.getElementById('test-notification-btn').addEventListener('click', function() {
                showMedicationAlert(
                    'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙˆØ§Ø¡',
                    new Date().toLocaleTimeString('ar-EG'),
                    'Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…'
                );
                
                addNotificationToHistory(
                    'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…',
                    'ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­',
                    'Ø¯ÙˆØ§Ø¡ ØªØ¬Ø±ÙŠØ¨ÙŠ',
                    new Date().toLocaleTimeString('ar-EG'),
                    Date.now().toString(),
                    'info'
                );
                
                showSystemNotification('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…', 'ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                showFloatingAlert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø±', 'success');
            });
            
            // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('sync-data-btn').addEventListener('click', async function() {
                showFloatingAlert('Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
                await loadSelectedPatientData();
                await loadRecentMedicationEvents();
                updateLastUpdateTime();
                showFloatingAlert('ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            });
            
            // ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±
            document.getElementById('export-report-btn').addEventListener('click', function() {
                exportReport();
            });
            
            // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
            document.getElementById('clear-notifications-btn').addEventListener('click', function() {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.')) {
                    appData.notifications = [];
                    appData.unreadNotifications = 0;
                    localStorage.removeItem('caregiverNotifications');
                    updateNotificationsDisplay();
                    showFloatingAlert('ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'success');
                }
            });
            
            // ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡
            document.getElementById('mark-all-read-btn').addEventListener('click', function() {
                appData.notifications.forEach(notification => {
                    notification.read = true;
                });
                appData.unreadNotifications = 0;
                updateNotificationsDisplay();
                localStorage.setItem('caregiverNotifications', JSON.stringify(appData.notifications));
                showFloatingAlert('ØªÙ… ØªØ¹Ù„ÙŠÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©', 'success');
            });
            
            // Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            document.getElementById('acknowledge-alert-btn').addEventListener('click', function() {
                document.getElementById('medication-alert').style.display = 'none';
            });
            
            // ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶
            document.getElementById('remind-patient-btn').addEventListener('click', function() {
                sendMessageToPatient('ØªØ°ÙƒÙŠØ±: Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø¯ÙˆØ§Ø¡');
                showFloatingAlert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ± Ù„Ù„Ù…Ø±ÙŠØ¶', 'success');
            });
            
            // Ø±Ø³Ø§Ø¦Ù„ Ø³Ø±ÙŠØ¹Ø©
            document.querySelectorAll('[data-message]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const message = this.getAttribute('data-message');
                    sendMessageToPatient(message);
                    showFloatingAlert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'success');
                });
            });
            
            // Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ©
            document.getElementById('custom-message-btn').addEventListener('click', function() {
                document.getElementById('message-box').style.display = 'block';
            });
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
            document.getElementById('send-message-btn').addEventListener('click', function() {
                const message = document.getElementById('message-input').value.trim();
                if (message) {
                    sendMessageToPatient(message);
                    document.getElementById('message-box').style.display = 'none';
                    document.getElementById('message-input').value = '';
                    showFloatingAlert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'success');
                }
            });
            
            // Ø¥Ù„ØºØ§Ø¡ Ø±Ø³Ø§Ù„Ø©
            document.getElementById('cancel-message-btn').addEventListener('click', function() {
                document.getElementById('message-box').style.display = 'none';
                document.getElementById('message-input').value = '';
            });
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª
        function setupSoundToggle() {
            const soundToggle = document.getElementById('sound-toggle');
            const soundIcon = document.getElementById('sound-icon');
            
            soundToggle.addEventListener('click', function() {
                appData.soundEnabled = !appData.soundEnabled;
                
                if (appData.soundEnabled) {
                    soundIcon.className = 'fas fa-volume-up';
                    soundToggle.style.background = '#4caf50';
                    soundToggle.style.color = 'white';
                    showFloatingAlert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª', 'success');
                } else {
                    soundIcon.className = 'fas fa-volume-mute';
                    soundToggle.style.background = '#f44336';
                    soundToggle.style.color = 'white';
                    showFloatingAlert('ØªÙ… ÙƒØªÙ… Ø§Ù„Ø£ØµÙˆØ§Øª', 'warning');
                }
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø±ÙŠØ¶
        async function sendMessageToPatient(message) {
            try {
                // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Firestore
                await db.collection('messages').add({
                    from: 'caregiver',
                    to: appData.selectedPatientId,
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                });
                
                console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø±ÙŠØ¶:', message);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ù„ÙŠ
                addNotificationToHistory(
                    'ğŸ“¨ Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø©',
                    `Ø£Ø±Ø³Ù„Øª Ù„Ù„Ù…Ø±ÙŠØ¶: "${message}"`,
                    'Ø±Ø³Ø§Ù„Ø©',
                    new Date().toLocaleTimeString('ar-EG'),
                    Date.now().toString(),
                    'info'
                );
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                showFloatingAlert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
            }
        }

        // ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±
        function exportReport() {
            const reportData = {
                caregiverId: appData.caregiverId,
                patientId: appData.selectedPatientId,
                patientName: appData.selectedPatientName,
                exportDate: new Date().toISOString(),
                patientData: appData.selectedPatientData,
                notifications: appData.notifications,
                statistics: {
                    totalMedications: document.getElementById('total-medications').textContent,
                    takenMedications: document.getElementById('taken-medications').textContent,
                    missedMedications: document.getElementById('missed-medications').textContent,
                    complianceRate: document.getElementById('compliance-rate').textContent
                }
            };
            
            const dataStr = JSON.stringify(reportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = `caregiver_report_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showFloatingAlert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ø¦Ù…
        function showFloatingAlert(message, type = 'info') {
            const alertDiv = document.getElementById('floating-alert');
            
            alertDiv.textContent = message;
            alertDiv.style.background = type === 'error' ? '#f44336' : 
                                      type === 'success' ? '#4caf50' : 
                                      type === 'warning' ? '#ff9800' : '#2196f3';
            
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
        async function updatePatientData() {
            if (appData.isConnected) {
                await loadSelectedPatientData();
                updateLastUpdateTime();
            }
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù…Ø®ØªØ§Ø±
        document.getElementById('patient-select').addEventListener('change', async function() {
            if (this.value) {
                appData.selectedPatientId = this.value;
                await loadSelectedPatientData();
                showFloatingAlert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'success');
            }
        });

        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø§ØªØµØ§Ù„ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        setInterval(() => {
            const timeElement = document.getElementById('connection-time');
            if (timeElement) {
                timeElement.textContent = new Date().toLocaleTimeString('ar-EG');
            }
        }, 1000);

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', checkConnection);
        window.addEventListener('offline', checkConnection);
    </script>
</body>
</html>